<body style="background: white"></body>
<script src="https://algorithmicmusic.online/js/libs/nn.min.js"></script>
<script src="https://unpkg.com/tone"></script>
<script src="https://algorithmicmusic.online/js/viz-helpers.js"></script>
<script>
/* global nn, Tone, viz */
const synth = new Tone.PolySynth().toDestination()

let chord
let scale

Tone.Transport.bpm.value = 120
Tone.Transport.loop = true
Tone.Transport.timeSignature = 4
Tone.Transport.loopEnd = '8m'

// chord progression, 1 degree for each measure
// II -> V -> VI -> I
const happyProgression = [1, 5, 6, 4,1, 5, 6, 4]
const sadProgression = [6, 4, 1, 5]
const evilProgression = [1, 5, 4, 5, 6, 5, 3, 7]

let currentProgression = happyProgression

function toggle () {
  if (Tone.Transport.state === 'stopped') {
    Tone.Transport.start()
    this.content('stop')
  } else {
    Tone.Transport.stop()
    this.content('start') // change button's text
  }
}

function highlightKeys () {
  pianoKeys.reset()
  scale.forEach(n => pianoKeys.attack(n, 'pink'))
  pianoKeys.attack(chord)
}

function play (time) {
  // get the current beat/bar
  const [bar, beat] = Tone.Transport.position.split(':').map(Number)

  // create a scale array three octaves long
  scale = [
    ...nn.createScale(keyList.value + 3, modeList.value),
    ...nn.createScale(keyList.value + 4, modeList.value),
    ...nn.createScale(keyList.value + 5, modeList.value)
  ]

  // only play chord on first beat
  if (beat === 0) {
    // get the degree for this measure
    const deg = currentProgression[bar]
    // rotate scale to next degree (-1 to convert degree to index value)
    const rscale = nn.rotateScale(scale, deg - 1)
    // create chord shape
    chord = nn.createChord(rscale, chordShapeList.value)
    // play the chord
    synth.triggerAttackRelease(chord, '1n', time)
    // update piano UI
    highlightKeys()
  }
}

new Tone.Loop(play).start()

// UI
nn.create('label')
  .content('scale: ')
  .addTo('body')

const keyList = nn.create('select')
  .set('options', nn.notes)
  .addTo('body')
  .on('change', highlightKeys)

const modeList = nn.create('select')
  .set('options', Object.keys(nn.modes))
  .addTo('body')
  .on('change', highlightKeys)

nn.create('button')
  .content('start')
  .css('margin-left', 20)
  .addTo('body')
  .on('click', toggle)

const chordShapeList = nn.create('select')
  .set('options', Object.keys(nn.chords))
  .addTo('body')

nn.create('br').addTo('body')
nn.create('br').addTo('body')

const pianoKeys = viz.createPianoUI({
  labels: true,
  octaves: [3, 6]
})

//Functions for moods

function happy() {
  currentProgression = happyProgression
  Tone.Transport.bpm.value = 1000
  const filter = new Tone.Filter(5000, "lowpass")
  const chorus = new Tone.Chorus(3, 1.8, 0.5).start()
  const reverb = new Tone.Reverb({ decay: 1.8, wet: 0.25 })
  const delay = new Tone.FeedbackDelay("8n", 0.15)
  synth.disconnect()
  synth.connect(filter)
  filter.connect(chorus)
  chorus.connect(delay)
  delay.connect(reverb)
  reverb.toDestination()
}

function sad() {
  currentProgression = sadProgression
  Tone.Transport.bpm.value = 80
  const filter = new Tone.Filter(2500, "lowpass")
  const chorus = new Tone.Chorus(1.2, 2.5, 0.25).start()
  const delay = new Tone.FeedbackDelay("8n", 0.25)
  const reverb = new Tone.Reverb({ decay: 2.8, wet: 0.35 })
  synth.disconnect()
  synth.connect(filter)
  filter.connect(chorus)
  chorus.connect(delay)
  delay.connect(reverb)
  reverb.toDestination()
}

function evil() {
  currentProgression = evilProgression
  Tone.Transport.bpm.value = 1000
  const filter = new Tone.Filter(1500, "highpass")
  const pitchShift = new Tone.PitchShift(0)
  const distortion = new Tone.Distortion(0.6)
  const reverb = new Tone.Reverb({ decay: 2.5, wet: 0.4 })
  synth.disconnect()
  synth.connect(filter)
  filter.connect(pitchShift)
  pitchShift.connect(distortion)
  pitchShift.connect(reverb)
  reverb.toDestination()
  
}
  
function original() {
  currentProgression = happyProgression
  synth.disconnect()
  synth.toDestination()
}

// Buttons to change mood preset
nn.create('button')
  .content('Happy')
  .addTo('body')
  .on('click', () => document.body.style.background = 'linear-gradient(to right, orange, yellow)')
  .on('click', () => happy())
  
nn.create('button')
  .content('Sad')
  .addTo('body')
  .on('click', () => document.body.style.background = 'linear-gradient(to right, blue, purple)')
  .on('click', () => sad())

nn.create('button')
  .content('Evil')
  .addTo('body')
  .on('click', () => document.body.style.background = 'linear-gradient(to right, red, black)')
  .on('click', () => evil())
  
nn.create('button')
  .content('Original')
  .addTo('body')
  .on('click', () => document.body.style.background = 'white')
  .on('click', () => original())

</script>